## Leader Dojo v0.5 实现清单

> 基于已拍板决策的工程实现蓝本，用于技术评审与落地排期。

---

### 一、基础原则与范围确认

- **用户与租户模型**
  - 单用户产品形态，但数据层一开始按多用户设计。
  - 所有业务表（`projects / project_entries / commitments / reflections` 等）必须包含 `user_id` 字段，按用户做行级隔离。

- **功能范围（v0.5 必须完成）**
  - Projects / Entries / Commitments / Dashboard / Quick Capture 全流程。
  - 完整反思流程：周/月反思入口、数据聚合、AI 生成问题、保存回答与历史查看。
  - 决策标记字段与基本查看能力（可先不做复杂提醒与日历式视图）。

- **AI 依赖范围（不可降级为纯规则的功能）**
  - Meeting / Update Entry：摘要 + 承诺建议。
  - 会前 Prep Briefing：基于项目时间线 + Commitments 的结构化 briefing。
  - 周/月反思：基于行为数据生成反思问题。
  - 若 AI 调用失败，前端做「失败提示 + 重试」而不是改成规则引擎。

- **明确不做（v0.5 之外）**
  - RAG / 向量库 / 知识图谱相关表与逻辑全部推迟到 v0.6+。
  - 定时任务、队列、站外推送（邮件、短信、通知）。
  - 独立 BFF 服务、多环境真正双云部署（只实现代码层面的可配置）。

---

### 二、技术选型与基础设施

- **前端 / 后端一体化**
  - Next.js App Router + React + TypeScript。
  - 使用 `app/*` 路由 + `app/api/*` Route Handlers + Server Components/Actions。
  - 不拆独立 BFF 进程，BFF 作为逻辑层存在于 `lib/services/*`。

- **数据库与 ORM**
  - 数据库：Neon Postgres（US 环境，后续可按 env 切换 CN 实例）。
  - ORM：Drizzle ORM。
  - 目录约定：
    - `src/lib/db/schema.ts`：业务表 schema 定义。
    - `src/lib/db/client.ts`：Drizzle + Postgres client 初始化（读 `DATABASE_URL`）。
    - `src/lib/repositories/*`：各实体的数据访问函数。

- **认证与会话**
  - 使用 Auth.js（NextAuth）+ Cookie session。
  - 登录方式：Email + Password（Credentials Provider）。
  - 标准 `users / accounts / sessions` 三表建模。
  - 所有受保护路由统一挂在 `/api/secure/*`，通过中间件校验 session 获取 `userId`。

- **AI 抽象**
  - 定义统一 `AiClient` 接口 + `aiClient` 单例，根据 `APP_REGION / AI_PROVIDER` 决定实现。
  - v0.5 实际只实现 US 版本（例如 OpenAI），CN 版本代码结构预留但不部署。

- **环境变量与配置**
  - 关键 env：
    - `APP_REGION=us`（预留 `cn` 分支）。
    - `DATABASE_URL=...`（Neon）。
    - `AI_PROVIDER=openai`。
    - `NEXTAUTH_URL / NEXTAUTH_SECRET / EMAIL_SERVER / EMAIL_FROM` 等。

---

### 三、数据模型与 Repository 层落地

- **核心业务表（均需添加 `user_id`）**
  - `users` / `accounts` / `sessions`（Auth.js 标准）。
  - `projects`：包含 `id, user_id, name, status, type, priority, owner_notes, last_active_at, created_at, updated_at`。
  - `project_entries`：包含 `id, user_id, project_id, kind, occurred_at, title, raw_content, ai_summary, ai_actions, is_key_decision, created_at`。
  - `commitments`：包含 `id, user_id, title, project_id, source_entry_id, direction, counterparty, due_date, importance, urgency, status, source, created_at, completed_at, notes`。
  - `reflections`：包含 `id, user_id, period_type, period, content, created_at`。

- **Repository 约定**
  - 不在组件、Route Handler 中直接使用 Drizzle，统一通过 `repositories/*`。
  - 为每个实体提供：
    - 基础 CRUD：`create / findById / listByUser / update`。
    - 关键查询：
      - Projects：按 user + filters + sort（priority / last_active_at）。
      - Entries：按 project + kind + 时间倒序。
      - Commitments：按 direction/status/due_date 等过滤与排序。
      - Reflections：按 user + period_type + 时间倒序。

---

### 四、领域服务与 API 设计

- **领域服务层（`lib/services/*`）**
  - `projectsService`：
    - 创建/更新 Project，默认填充 `status=active, priority=3`。
    - 获取项目列表与详情（包含 snapshot + last_active_at 维护）。
  - `entriesService`：
    - 创建 Entry（Meeting / Update / Self Note / Decision）。
    - 获取时间线（按 `occurred_at desc`，支持 kind 过滤）。
    - 标记决策字段、设置复盘时间（字段预留，逻辑可先简单）。
  - `commitmentsService`：
    - 从 AI 建议批量创建 Commitments（写入 `project_id / source_entry_id`）。
    - 查询 I Owe / Waiting For 列表 + 更新状态/截止日期等。
  - `dashboardService`：
    - 计算 Weekly Focus：基于 I Owe + importance + due_date + project priority。
    - 计算 Idle Projects：高优先级 + `now - last_active_at` 超阈值。
    - 汇总「待复盘决策」和「本期反思入口」的统计数据。
  - `reflectionsService`：
    - 汇总某周期内的行为数据（entries/commitments/statistics）。
    - 调用 `aiClient` 生成反思问题，拼接为可保存的反思内容。
    - 保存/查询反思记录。

- **API 路由（`app/api/secure/*`）**
  - `GET /api/secure/dashboard`：Dashboard 聚合数据。
  - `GET /api/secure/projects` / `POST /api/secure/projects`。
  - `GET /api/secure/projects/:id`。
  - `POST /api/secure/projects/:projectId/entries`。
  - `POST /api/secure/entries/:entryId/summarize`（调用 AI 生成摘要与承诺建议）。
  - `POST /api/secure/commitments` / `PATCH /api/secure/commitments/:id`。
  - `GET /api/secure/commitments`（支持 direction/status/filter）。
  - `GET /api/secure/reflections` / `POST /api/secure/reflections`。

---

### 五、AI 功能实现清单

- **AiClient 接口**
  - 方法：
    - `summarizeMeeting({ rawContent, projectContext })` → `{ summary, suggestedActions[] }`。
    - `generatePrepBriefing({ entries, commitments })` → `{ briefing }`。
    - `generateReflectionQuestions({ stats })` → `string[]`。
  - US 实现：基于 OpenAI（或等价），统一使用 JSON schema / structured output。

- **Meeting → 摘要 + 承诺建议**
  - Route：`POST /api/secure/entries/:entryId/summarize`。
  - 流程：
    - 后端加载 Entry（含 raw_content、project context）。
    - 调用 `aiClient.summarizeMeeting`。
    - 将 `ai_summary / ai_actions` 写回 `project_entries`。
    - 返回结构化结果给前端。
  - 前端：
    - Meeting Entry 详情中展示 AI 摘要与建议承诺列表。
    - 支持编辑摘要、勾选/修改建议承诺后批量创建 Commitments。

- **会前 Prep Briefing**
  - Route：`GET /api/secure/projects/:id/prep?days=90`。
  - 流程：
    - 聚合最近 N 条关键 entries（meeting/update/self_note/decision）。
    - 聚合该项目未完成 I Owe / Waiting For commitments。
    - 调用 `aiClient.generatePrepBriefing`，生成文本 briefing。
    - 返回结构化数据 + 文本 briefing。

- **周/月反思**
  - Route：`POST /api/secure/reflections`。
  - 流程：
    - 根据 period_type + period 统计本期行为数据。
    - 调用 `aiClient.generateReflectionQuestions` 得到 3–5 个问题。
    - 返回问题列表，前端展示并收集回答。
    - 用户提交后，将 Q&A 序列以 `content` 存入 `reflections`。

---

### 六、前端功能实现清单（Web-first, English UI）

- **全局约定**
  - UI 文案全部使用英文（项目名、Note 内容可自由输入多语言）。
  - 通过 Next.js App Router 构建以下页面：
    - `/dashboard`、`/projects`、`/projects/[id]`、`/commitments`、`/reflections`、`/capture`、`/auth/*`。

- **Dashboard 页面**
  - 区块：
    - Weekly Focus：展示 Top 5–10 I Owe commitments，支持一键完成/跳转项目。
    - Idle Projects：高优先级 + 长期未活跃项目列表。
    - Reflection & Decisions：显示当前周期可创建反思的入口、待复盘决策数。

- **Projects 列表 + 详情**
  - 列表：
    - 字段：name, status, type, priority, last_active_at。
    - 支持按 status/type/priority 筛选，priority/last_active_at 排序。
  - 详情：
    - Header Snapshot：基础信息 + `owner_notes` 摘要。
    - Timeline：按时间倒序展示 entries，支持 kind 过滤。
    - Commitments Panel：该项目所有未完成 I Owe / Waiting For。
    - 操作按钮：Add Entry / Prep（弹出 Prep Briefing 卡片）。

- **Entries 录入与查看**
  - 新建 Entry 表单：
    - kind、occurred_at、title、raw_content。
  - Meeting/Update Entry 支持「Generate summary & actions」按钮：
    - 调用 summarize API，展示可编辑摘要与建议承诺。

- **Commitments 页面**
  - Tabs：I Owe / Waiting For。
  - 列表字段：title, project, counterparty, due_date, importance, urgency, status。
  - 操作：过滤（项目/状态）、排序（due_date/importance）、编辑 status/due_date/notes。

- **Reflections 页面**
  - 列表：按时间倒序展示历史反思记录。
  - 创建反思：
    - 选择周期（week/month）。
    - 后端返回问题列表，前端以问答形式呈现。
    - 提交后保存为一条 reflection 记录并可再次查看。

- **Quick Capture (`/capture`)**
  - 移动优先单列布局。
  - 功能范围：
    - 仅支持「选择已有 Project + 输入文本 → 创建 Self Note Entry」。
    - 不在 `/capture` 中新建 Project，新建项目在 Projects 页面处理。
  - 行为：
    - 保存后清空文本，停留在当前页并展示轻量 toast。

---

### 七、安全、日志与隐私

- **接口安全**
  - 所有 `/api/secure/*` 通过中间件强制校验 Auth.js session。
  - 每个请求在服务层根据 `userId` 做行级过滤（所有查询都必须带 `user_id` 条件）。

- **日志策略**
  - 应用日志仅记录：
    - 请求路径、耗时、状态码、userId（可匿名化）、entry/commitment 的 ID。
  - 不记录任何用户输入的正文内容（raw_content、ai_summary、notes、reflection 文本等）。

- **导出能力（可选）**
  - v0.5 不强制实现 UI 按钮。
  - 代码层设计上，保留「按 userId 导出全部数据为 JSON」的服务层函数，未来可挂在受保护的导出 API。

---

### 八、阶段划分与优先级建议

- **Phase 1：基础数据层 + Auth + Projects/Entries/Commitments CRUD**
- **Phase 2：Meeting → AI 摘要与 Commitments 闭环 + Dashboard（Weekly Focus & Idle Projects）**
- **Phase 3：Prep Briefing（含 AI）+ Quick Capture**
- **Phase 4：Reflections 完整流程（数据聚合 + AI 问题 + Q&A 存储）**
- **Phase 5：体验与性能打磨、日志与隐私策略检查**

以上清单即为 v0.5 的工程实现范围，可在技术评审时作为讨论与排期的基线。


